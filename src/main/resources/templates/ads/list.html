<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(${pageTitle}, ${activeMenu}, ${breadcrumbs}, ~{::content})}">
<th:block th:fragment="content">
    <link th:href="@{/css/ads.css(v=${#dates.createNow().getTime()})}" rel="stylesheet">

    <div class="ads-page">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4 ads-page-header">
            <div>
                <h1 class="h3 mb-1 fw-semibold">광고 관리</h1>
                <p class="text-muted-soft mb-0">광고와 광고 스케줄을 한 곳에서 관리합니다.</p>
            </div>
        </div>

        <div class="row g-3 mb-4 ads-summary-row">
            <div class="col-12 col-md-4">
                <div class="card ads-summary-card ads-summary-card--placements h-100">
                    <div class="card-body">
                        <div class="ads-summary-icon">
                            <i class="bi bi-calendar3"></i>
                        </div>
                        <div class="ads-summary-label">지금 노출되고 있는 광고 수</div>
                        <div class="ads-summary-value" th:text="${summary.activePlacementCount()}">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${flashMessage}" class="alert alert-elevated d-flex align-items-center"
             th:classappend="${flashStatus} == 'success' ? ' alert-success' : ' alert-danger'">
            <i class="bi"
               th:classappend="${flashStatus} == 'success' ? ' bi-check-circle-fill me-2' : ' bi-exclamation-triangle-fill me-2'"></i>
            <span th:text="${flashMessage}">처리가 완료되었습니다.</span>
        </div>

        <div class="mb-3">
            <ul class="nav nav-tabs nav-tabs-line ads-tabs">
                <li class="nav-item">
                    <a class="nav-link" th:classappend="${tab} == 'ads' ? ' active'"
                       th:href="@{/ads(tab='ads')}">
                        광고
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:classappend="${tab} == 'schedule' ? ' active'"
                       th:href="@{/ads(tab='schedule')}">
                        광고 스케줄
                    </a>
                </li>
            </ul>
        </div>

        <!-- 광고 탭 -->
        <div th:if="${tab} == 'ads'">
            <div th:if="${adsLoadError}" class="alert alert-danger alert-elevated d-flex align-items-center mb-3">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span th:text="${adsLoadError}">광고 목록을 불러오지 못했습니다.</span>
            </div>

            <div class="card card-elevated ads-panel mb-4">
                <div class="card-body">
                    <h2 class="h6 mb-1 fw-semibold">광고</h2>
                    <p class="text-muted small mb-0">노출할 광고의 이름, 링크, 이미지를 설정합니다.</p>
                </div>
            </div>

            <div class="card card-elevated ads-panel">
                <div class="card-header card-header-tight d-flex justify-content-between align-items-center">
                    <h2 class="h6 mb-0 fw-semibold">광고 목록</h2>
                    <div th:if="${currentAdminProfile.isAdminEditor()}">
                        <a class="btn btn-sm btn-primary" th:href="@{/ads/new}">
                            <i class="bi bi-plus-circle me-1"></i>
                            <span>새 광고 등록</span>
                        </a>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0 ads-table">
                        <thead>
                        <tr>
                            <th scope="col">광고 이미지</th>
                            <th scope="col">광고 이름</th>
                            <th scope="col">이동할 링크(URL)</th>
                            <th scope="col">메모</th>
                            <th scope="col" class="text-end" th:if="${currentAdminProfile.isAdminEditor()}"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${ads.isEmpty()}">
                            <td class="text-center py-5 text-muted"
                                th:attr="colspan=${currentAdminProfile.isAdminEditor()} ? 5 : 4">
                                등록된 광고가 없습니다.
                            </td>
                        </tr>
                        <tr th:each="ad : ${ads}">
                            <td>
                                <div class="ratio ratio-4x3 ads-thumb-surface ads-thumb-surface--lg"
                                     th:if="${ad.hasImage()}">
                                    <img th:src="${ad.imageUrl()}" alt="광고 이미지" class="media-thumb w-100 h-100">
                                </div>
                                <div class="ads-thumb-placeholder ads-thumb-placeholder--lg"
                                     th:if="${!ad.hasImage()}">
                                    <i class="bi bi-image"></i>
                                </div>
                            </td>
                            <td class="fw-semibold" th:text="${ad.name()}">광고 이름</td>
                            <td>
                                <a th:href="${ad.targetUrl()}" th:text="${ad.targetUrl()}" class="text-break"
                                   target="_blank" rel="noopener">
                                    https://example.com
                                </a>
                            </td>
                            <td th:text="${#strings.isEmpty(ad.memo()) ? '-' : ad.memo()}">메모</td>
                            <td class="text-end" th:if="${currentAdminProfile.isAdminEditor()}">
                                <div class="d-inline-flex gap-2">
                                    <a class="btn btn-sm btn-outline-primary"
                                       th:href="@{/ads/edit(id=${ad.id()})}">수정</a>
                                    <form th:action="@{/ads/delete}" method="post" class="d-inline">
                                        <input type="hidden" name="id" th:value="${ad.id()}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                                th:onclick="|return confirm('정말 삭제하시겠습니까? 삭제하면 되돌릴 수 없습니다.');|">
                                            삭제
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 광고 스케줄 탭 -->
        <div th:if="${tab} == 'schedule'">
            <div class="card card-elevated ads-panel mb-4">
                <div class="card-body">
                    <h2 class="h6 mb-1 fw-semibold">광고 스케줄</h2>
                    <p class="text-muted small mb-0">광고를 노출할 스케줄을 설정합니다.</p>
                </div>
            </div>

            <div th:if="${placementsLoadError}"
                 class="alert alert-danger alert-elevated d-flex align-items-center mb-3">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span th:text="${placementsLoadError}">광고 노출 스케줄을 불러오지 못했습니다.</span>
            </div>

            <div th:if="${slotsLoadError}"
                 class="alert alert-danger alert-elevated d-flex align-items-center mb-3">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span th:text="${slotsLoadError}">광고 위치를 불러오지 못했습니다.</span>
            </div>

            <div th:if="${placementGroups.isEmpty()}" class="card card-elevated ads-panel">
                <div class="card-body text-center py-5 text-muted">
                    등록된 광고 노출 스케줄이 없습니다.
                </div>
            </div>

            <div th:each="group : ${placementGroups}" class="card card-elevated ads-panel mb-4">
                <div class="card-header card-header-tight d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div>
                        <h3 class="h6 mb-1 fw-semibold" th:text="${group.slotCode()}">HOME_TOP</h3>
                        <p class="text-muted small mb-0"
                           th:text="${#strings.isEmpty(group.slotDescription()) ? '설명이 없습니다.' : group.slotDescription()}">
                            광고 위치 설명
                        </p>
                    </div>
                    <div th:if="${currentAdminProfile.isAdminEditor()}" class="d-flex flex-wrap gap-2">
                        <a class="btn btn-sm btn-outline-primary"
                           th:href="@{/ads/placements/new(slotId=${group.slotId()})}">
                            <i class="bi bi-plus-circle me-1"></i>
                            <span>새 스케줄 등록</span>
                        </a>
                        <a class="btn btn-sm btn-outline-secondary"
                           th:if="${group.slotId() != null}"
                           th:href="@{/ads/slots/edit(id=${group.slotId()})}">광고 위치 설정</a>
                        <form th:if="${group.slotId() != null}" th:action="@{/ads/slots/delete}" method="post" class="d-inline">
                            <input type="hidden" name="id" th:value="${group.slotId()}">
                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                    th:onclick="|return confirm('정말 삭제하시겠습니까? 삭제하면 되돌릴 수 없습니다.');|">
                                이 광고 위치 삭제
                            </button>
                        </form>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0 ads-table">
                        <thead>
                        <tr>
                            <th scope="col">광고</th>
                            <th scope="col">진행 기간</th>
                            <th scope="col">우선순위</th>
                            <th scope="col">광고가 뜰 확률</th>
                            <th scope="col">진행 상태</th>
                            <th scope="col" class="text-end" th:if="${currentAdminProfile.isAdminEditor()}"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr class="ads-fallback-row">
                            <td>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="ads-fallback-icon flex-shrink-0">
                                        <i class="bi bi-stars"></i>
                                    </div>
                                    <div>
                                        <div class="fw-semibold">기본 광고</div>
                                        <div class="text-muted small">광고가 없을 때 표시되는 기본 콘텐츠입니다.</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-muted">-</td>
                            <td class="text-muted">-</td>
                            <td>
                                <span class="badge ads-probability-badge"
                                      th:classappend="${group.hasFallbackProbability()} ? ' ads-probability-badge--active' : ' ads-probability-badge--muted'"
                                      th:text="${group.fallbackProbabilityLabel()}">50%</span>
                            </td>
                            <td class="text-muted">-</td>
                            <td class="text-end" th:if="${currentAdminProfile.isAdminEditor()}">
                                <div class="d-inline-flex gap-2" th:if="${group.slotId() != null && group.slotCode() != null}">
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#fallbackRatioModal"
                                            th:attr="data-slot-id=${group.slotId()}, data-slot-code=${group.slotCode()}, data-fallback-ratio=${group.fallbackRatioPercent()}, data-slot-description=${group.slotDescription() == null ? '' : group.slotDescription()}, data-slot-ttl=${group.slotTtlSeconds()}"
                                            >기본 광고가 뜰 확률 수정</button>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${!group.hasPlacements()}">
                            <td class="text-center py-4 text-muted"
                                th:attr="colspan=${currentAdminProfile.isAdminEditor()} ? 6 : 5">
                                등록된 스케줄이 없습니다.
                            </td>
                        </tr>
                        <tr th:each="placement : ${group.placements()}">
                            <td>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="ratio ratio-1x1 ads-thumb-surface ads-thumb-surface--sm flex-shrink-0"
                                         th:if="${placement.hasImage()}">
                                        <img th:src="${placement.adImageUrl()}" alt="광고 미리보기"
                                             class="media-thumb w-100 h-100">
                                    </div>
                                    <div class="ads-thumb-placeholder ads-thumb-placeholder--sm flex-shrink-0"
                                         th:if="${!placement.hasImage()}">
                                        <i class="bi bi-image"></i>
                                    </div>
                                    <div class="fw-semibold" th:text="${placement.adName()}">광고 이름</div>
                                </div>
                            </td>
                            <td>
                                <div class="fw-semibold" th:text="${placement.periodLabel()}">2025.01.01 ~ 2025.01.31</div>
                            </td>
                            <td>
                                <span class="badge ads-priority-badge"
                                      th:classappend="${placement.priorityBadgeClass()}"
                                      th:text="${placement.weightLabel()}">매우 낮음</span>
                            </td>
                            <td>
                                <span class="badge ads-probability-badge"
                                      th:classappend="${placement.hasPositiveProbability()} ? ' ads-probability-badge--active' : ' ads-probability-badge--muted'"
                                      th:text="${placement.probabilityLabel()}">0%</span>
                            </td>
                            <td>
                                <span class="badge ads-status-badge"
                                      th:classappend="${placement.statusBadgeClass()}"
                                      th:text="${placement.displayStatusLabel()}">진행 중</span>
                            </td>
                            <td class="text-end" th:if="${currentAdminProfile.isAdminEditor()}">
                                <div class="d-inline-flex flex-wrap gap-2">
                                    <form th:if="${placement.canToggle()}" th:action="@{/ads/placements/toggle}"
                                          method="post" class="d-inline">
                                        <input type="hidden" name="id" th:value="${placement.id()}">
                                        <input type="hidden" name="enabled" th:value="${!placement.enabled()}">
                                        <button type="submit" class="btn btn-sm"
                                                th:classappend="${placement.enabled()} ? ' btn-outline-warning' : ' btn-outline-success'"
                                                th:onclick="${placement.enabled()} ? 'return confirm(\'이 스케줄을 일시 중지하면 광고가 노출되지 않습니다. 계속하시겠습니까?\');' : 'return confirm(\'이 스케줄을 다시 활성화합니다.\');'">
                                            <span th:text="${placement.enabled() ? '일시 중지' : '다시 활성화'}">일시 중지</span>
                                        </button>
                                    </form>
                                    <a class="btn btn-sm btn-outline-primary"
                                       th:href="@{/ads/placements/edit(id=${placement.id()})}">수정</a>
                                    <form th:action="@{/ads/placements/delete}" method="post" class="d-inline">
                                        <input type="hidden" name="id" th:value="${placement.id()}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                                th:onclick="|return confirm('정말 삭제하시겠습니까? 삭제하면 되돌릴 수 없습니다.');|">
                                            삭제
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-3" th:if="${currentAdminProfile.isAdminEditor()}">
                <a class="btn btn-outline-primary w-100" th:href="@{/ads/slots/new}">
                    <i class="bi bi-plus-circle me-1"></i>
                    <span>새 광고 위치 추가</span>
                </a>
            </div>
        </div>

        <div class="modal fade" id="fallbackRatioModal" tabindex="-1" aria-hidden="true"
             th:if="${currentAdminProfile.isAdminEditor()}">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form th:action="@{/ads/slots/edit}" method="post" class="needs-validation" novalidate>
                        <div class="modal-header">
                            <h5 class="modal-title">기본 광고 노출 확률 수정</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="id">
                            <input type="hidden" name="description">
                            <input type="hidden" name="ttlSeconds">
                            <input type="hidden" name="redirectTab" value="schedule">
                            <div class="mb-3">
                                <label class="form-label text-muted small">광고 위치</label>
                                <div class="fw-semibold fallback-slot-code">-</div>
                                <div class="text-muted small fallback-slot-description"></div>
                            </div>
                            <div class="mb-3">
                                <label for="fallbackRatioInput" class="form-label">기본 광고 노출 확률 (%)</label>
                                <input type="number" class="form-control" id="fallbackRatioInput" name="fallbackRatio"
                                       min="0" max="100" step="1" required>
                                <div class="form-text">현재 설정값: <span class="fallback-current-ratio">0%</span></div>
                                <div class="invalid-feedback">0에서 100 사이의 값을 입력하세요.</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
                            <button type="submit" class="btn btn-primary">저장</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var fallbackModal = document.getElementById('fallbackRatioModal');
            if (!fallbackModal) {
                return;
            }
            fallbackModal.addEventListener('show.bs.modal', function (event) {
                var trigger = event.relatedTarget;
                if (!trigger) {
                    return;
                }

                var slotId = trigger.getAttribute('data-slot-id');
                var slotCode = trigger.getAttribute('data-slot-code');
                var fallbackRatio = trigger.getAttribute('data-fallback-ratio');
                var slotDescription = trigger.getAttribute('data-slot-description') || '';
                var slotTtl = trigger.getAttribute('data-slot-ttl') || '0';

                var idInput = fallbackModal.querySelector('input[name="id"]');
                var ratioInput = fallbackModal.querySelector('input[name="fallbackRatio"]');
                var descriptionInput = fallbackModal.querySelector('input[name="description"]');
                var ttlInput = fallbackModal.querySelector('input[name="ttlSeconds"]');
                if (idInput) {
                    idInput.value = slotId || '';
                }
                if (ratioInput) {
                    ratioInput.value = fallbackRatio || '';
                }
                if (descriptionInput) {
                    descriptionInput.value = slotDescription;
                }
                if (ttlInput) {
                    ttlInput.value = slotTtl;
                }

                var codeLabel = fallbackModal.querySelector('.fallback-slot-code');
                if (codeLabel) {
                    codeLabel.textContent = slotCode || '-';
                }

                var descriptionLabel = fallbackModal.querySelector('.fallback-slot-description');
                if (descriptionLabel) {
                    descriptionLabel.textContent = slotDescription || '설명이 없습니다.';
                }

                var currentRatioLabel = fallbackModal.querySelector('.fallback-current-ratio');
                if (currentRatioLabel) {
                    var ratioNumber = Number(fallbackRatio);
                    currentRatioLabel.textContent = Number.isFinite(ratioNumber)
                        ? Math.round(ratioNumber) + '%'
                        : '-';
                }
            });
        });
        </script>

    </div>
</th:block>
</html>
