<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/_head :: head('새록 어드민 로그인')}"></head>
<body class="login-page">

<!--
  풀 블리드 사진을 배경으로 깔고(login-visual), 그 위에 반투명 패널(login-panel)을 오버레이
  - 데스크톱: 우측에 카드 정렬
  - 모바일: 가운데 정렬, 뒤 사진이 은은하게 보이도록 투명도/블러 적용
  - Unsplash 키는 서버 프록시(/public/unsplash/random-bird)로만 사용
-->

<div class="login-shell">
    <!-- Background visual (full-bleed) -->
    <aside class="login-visual">
        <a id="photoLink" class="login-visual__image-link" href="#" target="_blank" rel="noopener">
            <img id="loginPhoto" class="login-visual__image" alt="" decoding="async">
        </a>
        <!-- 전체 화면용 스크림: 좌→우로 점차 약해지며, 텍스트 대비 확보 -->
        <div class="login-visual__scrim"></div>
        <p class="login-visual__credit small mb-0">
            <span id="attribution">사진을 불러오는 중…</span>
        </p>
    </aside>

    <!-- Foreground panel (translucent) -->
    <section class="login-panel">
        <div class="login-panel__inner">
            <div class="card login-card shadow-soft border-0">
                <div class="card-body p-4 p-md-5">
                    <div class="text-center mb-4">
                        <img class="login-logo"
                             th:src="@{/images/saerok-admin-icon.png}"
                             src="/images/saerok-admin-icon.png"
                             alt="새록 어드민 로고"
                             decoding="async">
                        <div class="d-flex align-items-center justify-content-center gap-2 mt-3 flex-wrap">
                            <h1 class="h4 fw-bold mb-0">새록 어드민</h1>
                            <span class="environment-badge"
                                  th:if="${environmentProfileBadge}"
                                  th:classappend="' ' + ${environmentProfileBadge.cssClass()}"
                                  th:text="${environmentProfileBadge.label()}">운영</span>
                        </div>
                        <p class="text-muted small mb-0">운영자 전용 로그인 페이지입니다.</p>
                    </div>

                    <div class="alert alert-danger d-flex align-items-start" role="alert" th:if="${param.error}">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div th:switch="${param.error[0]}">
                            <span th:case="'state'">보안 검증에 실패했습니다. 다시 로그인해주세요.</span>
                            <span th:case="'callback'">필수 인증 정보가 누락되었습니다. 다시 시도해주세요.</span>
                            <span th:case="'session'">세션이 만료되었습니다. 다시 로그인해주세요.</span>
                            <span th:case="'login'">
                                <span th:if="${param.message}" th:text="${param.message[0]}"></span>
                                <span th:unless="${param.message}">로그인 중 오류가 발생했습니다. 다시 시도해주세요.</span>
                            </span>
                            <span th:case="*">로그인에 실패했습니다. 다시 시도해주세요.</span>
                        </div>
                    </div>

                    <div class="d-grid gap-3">
                        <a th:href="${kakaoAuthUrl}"
                           class="btn btn-lg w-100 d-flex align-items-center justify-content-center gap-2"
                           role="button"
                           style="background-color: #FEE500; color: #191600;"
                           aria-label="카카오 계정으로 로그인">
                            <img th:src="@{/images/kakao-symbol.svg}" src="/images/kakao-symbol.svg" alt="카카오 심볼" width="20" height="20">
                            <span class="fw-semibold">카카오로 로그인</span>
                        </a>

                        <div class="tooltip-wrapper"
                             data-bs-toggle="tooltip"
                             data-bs-placement="top"
                             data-bs-title="추후 제공 예정인 기능">
                            <button type="button"
                                    class="btn btn-lg w-100 d-flex align-items-center justify-content-center gap-2 upcoming-feature"
                                    style="background-color: #000000; color: #ffffff;"
                                    aria-disabled="true" disabled>
                                <i class="bi bi-apple fs-4" aria-hidden="true"></i>
                                <span class="fw-semibold">Sign in with Apple</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<th:block th:replace="~{fragments/_scripts :: scripts}"></th:block>

<script>
    const imgEl  = document.getElementById('loginPhoto');
    const linkEl = document.getElementById('photoLink');
    const attrEl = document.getElementById('attribution');

    // imgix(Unsplash CDN) 파라미터: 화면 크기에 맞춰 다운샘플 + entropy 크롭
    function buildSmartUrl(base, w, h) {
        try {
            const u = new URL(base);
            u.searchParams.set('w', Math.round(w));
            u.searchParams.set('h', Math.round(h));
            u.searchParams.set('q', '80');
            u.searchParams.set('auto', 'format');
            u.searchParams.set('fit', 'crop');
            u.searchParams.set('crop', 'entropy');
            return u.toString();
        } catch { return base; }
    }

    function renderImage(baseUrl) {
        if (!baseUrl) return;
        const rect = document.querySelector('.login-visual').getBoundingClientRect();
        const dpr  = Math.min(2, window.devicePixelRatio || 1);
        const w = rect.width  * dpr;
        const h = rect.height * dpr;
        imgEl.src = buildSmartUrl(baseUrl, w, h);
    }

    async function loadRandomBirdViaProxy() {
        try {
            const res = await fetch('/public/unsplash/random-bird', { cache: 'no-store' });
            if (!res.ok) throw new Error('Proxy request failed: ' + res.status);
            const data = await res.json();

            // 클릭 시 Unsplash 사진 페이지로(가이드라인 준수)
            linkEl.href = data.htmlLink;

            // 저작자/Unsplash 표기(가이드라인 준수)
            const photographerName = data.photographerName || 'Unknown';
            const photographerLink = data.photographerLink || data.unsplashHome || 'https://unsplash.com';
            const unsplashHome     = data.unsplashHome || 'https://unsplash.com';
            attrEl.innerHTML = `Photo by <a href="${photographerLink}" target="_blank" rel="noopener">${photographerName}</a> on <a href="${unsplashHome}" target="_blank" rel="noopener">Unsplash</a>`;

            // 서버에서 orientation=landscape 로 공급 → 화면 맞춤만 수행
            renderImage(data.imageUrl);

            // 리사이즈/회전 시 재렌더
            let base = data.imageUrl;
            const ro = new ResizeObserver(() => renderImage(base));
            ro.observe(document.querySelector('.login-visual'));
            window.addEventListener('orientationchange', () => setTimeout(() => renderImage(base), 250));
        } catch (e) {
            console.warn(e);
            attrEl.textContent = '이미지를 불러오지 못했습니다.';
        }
    }
    document.addEventListener('DOMContentLoaded', loadRandomBirdViaProxy);

    // 툴팁 초기화
    document.addEventListener('DOMContentLoaded', function () {
        if (!window.bootstrap || !window.bootstrap.Tooltip) return;
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (triggerEl) {
            var existing = window.bootstrap.Tooltip.getInstance(triggerEl);
            if (existing) existing.dispose();
            new window.bootstrap.Tooltip(triggerEl, {
                trigger: 'hover focus',
                delay: { show: 0, hide: 100 },
                customClass: 'tooltip-bubble'
            });
        });
    });
</script>

<style>
    :root{
        --panel-bg: rgba(248,250,252,.80);      /* 로그인 패널 배경 투명도 */
        --panel-bg-strong: rgba(248,250,252,.88);
        --panel-border: rgba(255,255,255,.28);
        --panel-shadow: 0 20px 40px rgba(15,23,42,.25);
        --scrim-left: rgba(7,11,22,.45);        /* 좌측 스크림(데스크톱 대비용) */
        --scrim-right: rgba(7,11,22,.10);
    }

    /* 화면 전체 컨테이너 */
    .login-page{min-height:100dvh;background:#0b1220;overflow:hidden;}
    .login-shell{position:relative;min-height:100dvh;}

    /* 풀블리드 사진 레이어 (뒤) */
    .login-visual{position:absolute;inset:0;z-index:0;overflow:hidden;background:#0b1220;}
    .login-visual__image-link,.login-visual__image{display:block;width:100%;height:100%;}
    .login-visual__image{object-fit:cover;}
    .login-visual__scrim{
        position:absolute;inset:0;pointer-events:none;
        background: linear-gradient(90deg, var(--scrim-left) 0%, rgba(7,11,22,.25) 40%, var(--scrim-right) 100%);
    }
    .login-visual__credit{
        position:absolute;left:1rem;bottom:1rem;padding:.35rem .55rem;
        background: rgba(0,0,0,.45); color:#fff; border-radius:.5rem; backdrop-filter: blur(2px);
        text-shadow: 0 1px 1px rgba(0,0,0,.6);
    }
    .login-visual__credit a{color:#fff;text-decoration:underline;}

    /* 오버레이 패널 (앞)
       - 패널 전체는 클릭 통과(pointer-events:none) → 사진 링크 클릭 가능
       - 카드 내부만 클릭 활성(pointer-events:auto)
    */
    .login-panel{
        position:relative; z-index:1; min-height:100dvh;
        display:flex; align-items:center; justify-content:flex-end;
        padding: clamp(1rem, 4vw, 3rem);
        pointer-events: none; /* ✨ 핵심: 배경 사진 클릭 허용 */
    }
    .login-panel__inner{
        width:100%; max-width: 520px; margin-left:auto;
        pointer-events: auto; /* ✨ 카드 내부만 상호작용 가능 */
    }

    .login-card{
        width:100%;
        background: var(--panel-bg);
        backdrop-filter: saturate(140%) blur(10px);
        -webkit-backdrop-filter: saturate(140%) blur(10px);
        border: 1px solid var(--panel-border);
        border-radius: 1rem;
        box-shadow: var(--panel-shadow);
    }

    .login-logo{
        inline-size: clamp(64px, 12vw, 96px);
        block-size: clamp(64px, 12vw, 96px);
        display:inline-block;
    }

    .shadow-soft{ box-shadow: var(--panel-shadow) !important; }

    /* 툴팁 스타일(기존) */
    .tooltip-bubble .tooltip-inner{
        background-color:#1f2937;color:#fff;border-radius:.5rem;box-shadow:0 10px 25px rgba(0,0,0,.2);
        padding:.5rem .75rem;
    }
    .tooltip-bubble .tooltip-arrow::before{border-top-color:#1f2937;}

    /* 모바일 레이아웃: 카드 가운데 정렬, 뒤 사진 비침 유지 */
    @media (max-width: 991.98px){
        :root{
            --panel-bg: rgba(248,250,252,.76);
            --scrim-left: rgba(7,11,22,.25);
            --scrim-right: rgba(7,11,22,.12);
        }
        .login-panel{
            justify-content: center;
            padding: clamp(1rem, 6vw, 2rem);
        }
        .login-panel__inner{
            max-width: 560px; margin-inline:auto;
        }
        .login-visual__credit{font-size:.75rem;}
    }

    /* 아주 밝은 사진에서도 텍스트 대비 확보를 위해 카드 내부 텍스트에 약한 텍스트-쉐도우 (필요시 확장) */
    .login-card .h4, .login-card p, .login-card span, .login-card a, .login-card .btn {
        text-shadow: 0 0 0 rgba(0,0,0,0); /* 기본은 없음 */
    }
</style>

</body>
</html>
